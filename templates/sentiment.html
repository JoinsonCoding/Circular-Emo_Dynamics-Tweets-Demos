<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Twitter-roBERTa Sentiment Analyzer</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.container { max-width: 700px; margin:auto; padding:20px; font-family:system-ui; }
textarea { width:100%; height:80px; margin-bottom:10px; }
button { padding:8px 12px; margin:5px; border:none; border-radius:6px; background:#3498db; color:white; cursor:pointer; }
button:hover { background:#2980b9; }
#reset { background:#e74c3c; }
#reset:hover { background:#c0392b; }
.result-bar { display:flex; align-items:center; margin-bottom:10px; }
.emoji { font-size:30px; margin-right:10px; }
.result { font-weight:bold; }
.summary { margin-top:20px; background:#f9f9f9; padding:15px; border-radius:6px; border:1px solid #ddd; }
.summary div { margin-bottom:5px; }
.mssd-container { margin-top:20px; background:#f9f9f9; padding:10px; border-radius:6px; border:1px solid #ddd; }
.back-btn { background:#7f8c8d; color:white; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; margin:5px; }
.back-btn:hover { background:#95a5a6; }
</style>
</head>
<body>
<div class="container">
  <h1>Twitter-roBERTa Sentiment Analyzer</h1>
  <textarea id="tweet" placeholder="Type your fake tweet here..."></textarea><br />
  <button id="analyze">Analyze Sentiment</button>
  <button id="reset">Reset</button>
  <button class="back-btn" onclick="location.href='/'">Back to Home</button>

  <div class="result-bar">
    <div id="emoji" class="emoji">â€”</div>
    <div id="result" class="result">Prediction: â€”</div>
  </div>
  <div id="error" class="error"></div>

  <canvas id="sentimentChart" width="500" height="300"></canvas>

  <div class="summary">
    <h3>Summary Statistics</h3>
    <div id="summaryPositive">Positive Mean: â€” , SD: â€”</div>
    <div id="summaryNegative">Negative Mean: â€” , SD: â€”</div>
  </div>

  <div class="mssd-container">
    <h3>Time-Adjusted MSSD</h3>
    <label for="intervalSlider">Time interval between tweets (minutes): <span id="intervalVal">60</span></label><br>
    <input type="range" min="1" max="360" value="60" id="intervalSlider">

    <div id="mssdPositiveResult">Positive MSSD: â€”</div>
    <pre id="mssdPositiveCalculation"></pre>

    <div id="mssdNegativeResult">Negative MSSD: â€”</div>
    <pre id="mssdNegativeCalculation"></pre>
  </div>
</div>

<script>
const analyzeBtn = document.getElementById("analyze");
const resetBtn = document.getElementById("reset");
const tweetEl = document.getElementById("tweet");
const resultEl = document.getElementById("result");
const emojiEl = document.getElementById("emoji");
const errorEl = document.getElementById("error");
const summaryPositiveEl = document.getElementById("summaryPositive");
const summaryNegativeEl = document.getElementById("summaryNegative");
const mssdPositiveResult = document.getElementById("mssdPositiveResult");
const mssdNegativeResult = document.getElementById("mssdNegativeResult");
const mssdPositiveCalculation = document.getElementById("mssdPositiveCalculation");
const mssdNegativeCalculation = document.getElementById("mssdNegativeCalculation");
const intervalSlider = document.getElementById("intervalSlider");
const intervalVal = document.getElementById("intervalVal");

let tweets = [];
let positiveData = [];
let negativeData = [];
let tweetTimes = [];

const ctx = document.getElementById('sentimentChart').getContext('2d');
const sentimentChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: tweets,
        datasets: [
            { label: 'Positive (%)', data: positiveData, borderColor: 'green', backgroundColor:'rgba(0,255,0,0.1)', fill:true, tension:0.2 },
            { label: 'Negative (%)', data: negativeData, borderColor: 'red', backgroundColor:'rgba(255,0,0,0.1)', fill:true, tension:0.2 }
        ]
    },
    options: { responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }
});

function mean(arr){ return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }
function std(arr){ if(arr.length<2) return 0; const m=mean(arr); return Math.sqrt(arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length); }

function computeTimeAdjustedMSSD(scores, times, displayCalc) {
    const n = scores.length;
    if(n<2) return null;
    let diffs=[], intervals=[];
    for(let i=0;i<n-1;i++){
        const deltaX = scores[i+1]-scores[i];
        const deltaT = times[i+1]-times[i];
        if(deltaT===0) continue;
        diffs.push(deltaX*deltaX/deltaT);
        intervals.push(deltaT);
    }
    if(diffs.length===0) return 0;
    intervals.sort((a,b)=>a-b);
    const mid=Math.floor(intervals.length/2);
    const medianDt= intervals.length%2===0 ? (intervals[mid-1]+intervals[mid])/2 : intervals[mid];
    const sumDiffs = diffs.reduce((a,b)=>a+b,0);
    const mssd = (medianDt/(n-1))*sumDiffs;

    if(displayCalc){
        let calcText = "Step 1: Î”xÂ² / Î”t for each pair: [" + diffs.map(d=>d.toFixed(2)).join(", ") + "]\n";
        calcText += "Step 2: Sum of above: " + sumDiffs.toFixed(2) + "\n";
        calcText += "Step 3: Median interval: " + medianDt.toFixed(2) + "\n";
        calcText += "Step 4: MSSD = (median Î”t / (N-1)) * sum = " + mssd.toFixed(2);
        displayCalc.textContent = calcText;
    }
    return mssd;
}

function updateSummary() {
    summaryPositiveEl.textContent = `Positive Mean: ${mean(positiveData).toFixed(1)} , SD: ${std(positiveData).toFixed(1)}`;
    summaryNegativeEl.textContent = `Negative Mean: ${mean(negativeData).toFixed(1)} , SD: ${std(negativeData).toFixed(1)}`;
    
    const interval = parseFloat(intervalSlider.value);
    tweetTimes = positiveData.map((_,i)=>i*interval);

    const posMSSD = computeTimeAdjustedMSSD(positiveData, tweetTimes, mssdPositiveCalculation);
    const negMSSD = computeTimeAdjustedMSSD(negativeData, tweetTimes, mssdNegativeCalculation);

    mssdPositiveResult.textContent = posMSSD!==null ? `Positive MSSD: ${posMSSD.toFixed(2)}` : "Positive MSSD: â€”";
    mssdNegativeResult.textContent = negMSSD!==null ? `Negative MSSD: ${negMSSD.toFixed(2)}` : "Negative MSSD: â€”";
}

intervalSlider.oninput = ()=> {
    intervalVal.textContent = intervalSlider.value;
    updateSummary();
};

analyzeBtn.onclick = async ()=>{
    errorEl.textContent = ""; resultEl.textContent="Prediction: â€¦"; emojiEl.textContent="â€¦";
    const text = tweetEl.value.trim();
    if(!text){ errorEl.textContent="Please enter some text."; return; }
    try{
        const resp = await fetch("/analyze", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({text})
        });
        const data = await resp.json();
        if(data.error) throw new Error(data.error);

        tweets.push(text); positiveData.push(data.positive); negativeData.push(data.negative);

        sentimentChart.data.labels = tweets;
        sentimentChart.data.datasets[0].data = positiveData;
        sentimentChart.data.datasets[1].data = negativeData;
        sentimentChart.update();

        // pick the stronger class (positive vs negative)
        if(data.positive >= data.negative){
            resultEl.textContent = `Prediction: Positive (${data.positive}%)`;
            emojiEl.textContent = "ðŸ˜Š";
        } else {
            resultEl.textContent = `Prediction: Negative (${data.negative}%)`;
            emojiEl.textContent = "â˜¹ï¸";
        }

        updateSummary();
        tweetEl.value="";
    }catch(err){ errorEl.textContent="Error: "+err.message; resultEl.textContent="Prediction: â€”"; emojiEl.textContent="â€”"; }
};

resetBtn.onclick = ()=>{
    tweets=[]; positiveData=[]; negativeData=[]; tweetTimes=[];
    sentimentChart.data.labels=[]; sentimentChart.data.datasets[0].data=[]; sentimentChart.data.datasets[1].data=[];
    sentimentChart.update();
    tweetEl.value=""; resultEl.textContent="Prediction: â€”"; emojiEl.textContent="â€”"; errorEl.textContent="";
    summaryPositiveEl.textContent="Positive Mean: â€” , SD: â€”"; summaryNegativeEl.textContent="Negative Mean: â€” , SD: â€”";
    mssdPositiveResult.textContent="Positive MSSD: â€”"; mssdNegativeResult.textContent="Negative MSSD: â€”";
    mssdPositiveCalculation.textContent=""; mssdNegativeCalculation.textContent="";
};
</script>
</body>
</html>
